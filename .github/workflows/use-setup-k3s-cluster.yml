name: Workflow Call Setup K3S Cluster
on:
  workflow_call:
    inputs:
      domain:
        required: true
        type: string
      cluster_name:
        required: true
        type: string
      ssh_host_name:
        required: true
        type: string
    secrets:
      GCP_CREDENTIALS_JSON:
        required: true
      SSH_PRIVATE_KEY:
        required: true
      DNS_AK:
        required: true
      DNS_SK:
        required: true
      SSH_USER:
        required: true
      VAULT_URL:
        required: true
      VAULT_TOKEN:
        required: true

jobs:
  init-k3s-cluster:
    runs-on: ubuntu-latest
    env:
      DOMAIN: ${{ inputs.domain }}
      DNS_AK: ${{ secrets.DNS_AK }}
      DNS_SK: ${{ secrets.DNS_SK }}
      VAULT_URL: ${{ secrets.VAULT_URL }}
      VAULT_TOKEN: ${{ secrets.VAULT_TOKEN }}
      VAULT_SECRET_PATH: certs/data/${{ inputs.domain }}
      SSH_USER: ${{ secrets.SSH_USER }}
      SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      SSH_HOST_DOMAIN: "${{ inputs.ssh_host_name }}.${{ inputs.domain }}"
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          submodules: 'recursive'

      - name: Pre Setup
        run: |
          sudo apt-get update
          sudo apt install -y software-properties-common
          curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/hashicorp-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list > /dev/null
          sudo apt-get update
          sudo apt-get install -y python3-pip jq vault
          pip3 install ansible jinja2 hvac
          ansible-galaxy collection install community.hashi_vault

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v1
        with:
          terraform_version: 1.6.4

      - name: Authenticate with Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS_JSON }}

      - name: Extract SSH Host IP and Set as Env Variable
        run: |
          python3 scripts/init.py && terraform init
          terraform output -raw ${{ inputs.ssh_host_name }}
          echo "SSH_HOST_IP=$(terraform-bin output -raw ${{ inputs.ssh_host_name }} 2>/dev/null)" >> $GITHUB_ENV
        shell: bash
        working-directory: iac_modules/terraform/gcp/vhost/

      - name: Update playbook hosts
        run: bash ansible_playbook_hosts_setup.sh 
        working-directory: playbook/ 

      - name: Setup K3S Cluster
        shell: bash
        run: |
          export ANSIBLE_HOST_KEY_CHECKING=False
          ansible-playbook -i hosts/inventory init_k3s_cluster_std     \
                           -e "dns_ak=$DNS_AK"                         \
                           -e "dns_sk=$DNS_SK"                         \
                           -e "vault_url=$VAULT_URL"                   \
                           -e "vault_token=$VAULT_TOKEN"               \
                           -e "vault_secret_path=$VAULT_SECRET_PATH"   \
                           -e "cluster_name=${{inputs.ssh_host_name}}" \
                           -e "domain=${{inputs.domain}}" -D
        working-directory: playbook/ 
